{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>{% if object %}Editar{% else %}Agregar{% endif %} Participante</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: url("{% static 'img/exponentes.png' %}") no-repeat center center fixed;
            background-size: cover;
            color: #f0f0f0;
            min-height: 100vh;
            font-family: Arial, sans-serif;
            position: relative;
        }
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 0;
        }
        .content { position: relative; z-index: 1; }
        .card {
            background-color: rgba(30, 0, 60, 0.6);
            border-radius: 15px;
            color: #ffffff;
        }
        .card-header {
            background-color: rgba(106, 13, 173, 0.8);
            color: #fff;
            font-weight: bold;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }
        .form-label { color: #e0c3fc; }
        .form-control {
            background-color: rgba(42,0,51,0.7);
            border: 1px solid rgba(106,13,173,0.7);
            color: #fff;
        }
        .form-control:focus {
            background-color: rgba(59,0,77,0.8);
            border-color: #c100ff;
            box-shadow: 0 0 10px #c100ff;
            color: #fff;
        }
        .btn-primary { background-color: #6a0dad; border-color: #4b0082; }
        .btn-primary:hover { background-color: #8000ff; border-color: #4b0082; }
        .btn-outline-secondary { color: #fff; border-color: #c100ff; }
        .btn-outline-secondary:hover { background-color: #4b0082; border-color: #c100ff; }
        .preview-container img {
            max-height: 100px;
            margin-right: 10px;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
<div class="container py-5 content">

    <div class="mb-4 text-center">
        <h4 id="reloj" class="fw-bold"></h4>
        <div id="mensaje-preventa" class="fw-semibold"></div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">
            {% if object %}
                <i class="bi bi-pencil-square"></i> Editar Participante
            {% else %}
                <i class="bi bi-person-plus-fill"></i> Agregar Participante
            {% endif %}
        </h2>
        <a href="{% url 'lista' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left-circle"></i> Volver a la lista
        </a>
    </div>

    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card shadow-sm p-3">
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <div class="row g-3">
                            {% for field in form %}
                                <div class="col-md-12">
                                    <label class="form-label fw-semibold">{{ field.label }}</label>
                                    {{ field }}
                                    {% for error in field.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endfor %}

                            <!-- Tipo de tarifa -->
                            <div class="col-md-12">
                                <label class="form-label fw-semibold">Tipo de Tarifa</label>
                                <select id="tipo_tarifa" class="form-control" name="tipo_tarifa">
                                    <option value="">Seleccione</option>
                                    <option value="pre1">Preventa 1</option>
                                    <option value="pre2">Preventa 2</option>
                                    <option value="pre3">Preventa 3</option>
                                    <option value="puerta">Puerta</option>
                                </select>
                            </div>

                            <!-- Precio automático -->
                            <div class="col-md-12">
                                <label class="form-label fw-semibold">Precio</label>
                                <input type="text" id="precio" class="form-control" readonly>
                                <input type="hidden" name="precio_final" id="precio_final">
                            </div>

                            <!-- Sección de vouchers -->
                            <div class="col-md-12 mt-3">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-paperclip"></i> Voucher(s) de pago
                                </label>
                                <input type="file" id="voucherInput" name="vouchers" class="form-control" multiple accept="image/*,.pdf">
                                <small class="text-light">Puedes adjuntar uno o varios archivos (imágenes o PDF).</small>
                                <div id="preview" class="preview-container mt-2 d-flex flex-wrap"></div>
                            </div>
                        </div>

                        <div class="mt-4 text-end">
                            <button type="submit" class="btn btn-primary">
                                {% if object %}
                                    <i class="bi bi-save-fill"></i> Actualizar
                                {% else %}
                                    <i class="bi bi-check-circle-fill"></i> Agregar
                                {% endif %}
                            </button>
                            <a href="{% url 'lista' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Tabla de precios -->
        <div class="col-lg-6">
            <div class="card shadow-sm border-primary">
                <div class="card-header">
                    <i class="bi bi-ticket-perforated-fill"></i> Tarifas de Entradas
                </div>
                <div class="card-body p-0">
                    <table class="table table-bordered text-center align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Preventa 1</th>
                                <th>Preventa 2</th>
                                <th>Preventa 3</th>
                                <th>Puerta</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td class="fw-bold">FULL ACCES</td><td>1050</td><td>1500</td><td>2100</td><td class="text-danger fw-bold">3000</td></tr>
                            <tr><td class="fw-bold">EMPRESARIAL</td><td>525</td><td>750</td><td>1050</td><td class="text-danger fw-bold">1800</td></tr>
                            <tr><td class="fw-bold">EMPRENDEDOR</td><td>105</td><td>150</td><td>210</td><td class="text-danger fw-bold">750</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const precios = {
    "FULL ACCES": { pre1: 1050, pre2: 1500, pre3: 2100, puerta: 3000 },
    "EMPRESARIAL": { pre1: 525, pre2: 750, pre3: 1050, puerta: 1800 },
    "EMPRENDEDOR": { pre1: 105, pre2: 150, pre3: 210, puerta: 750 }
};

document.addEventListener("DOMContentLoaded", () => {
    const tipoEntrada = document.querySelector('[name="tipo_entrada"]');
    const tipoTarifa = document.getElementById("tipo_tarifa");
    const precio = document.getElementById("precio");
    const precioFinal = document.getElementById("precio_final");

    function actualizarPrecio() {
        if (tipoEntrada.value && tipoTarifa.value && precios[tipoEntrada.value]) {
            const valor = precios[tipoEntrada.value][tipoTarifa.value];
            precio.value = valor;
            precioFinal.value = valor;
        } else {
            precio.value = "";
            precioFinal.value = "";
        }
    }

    tipoEntrada.addEventListener("change", actualizarPrecio);
    tipoTarifa.addEventListener("change", actualizarPrecio);

    // Vista previa de vouchers
    const voucherInput = document.getElementById("voucherInput");
    const preview = document.getElementById("preview");

    voucherInput.addEventListener("change", () => {
        preview.innerHTML = "";
        [...voucherInput.files].forEach(file => {
            if (file.type.startsWith("image/")) {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.createElement("img");
                    img.src = e.target.result;
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            } else {
                const div = document.createElement("div");
                div.classList.add("text-info", "me-2");
                div.innerHTML = `<i class="bi bi-file-earmark-pdf"></i> ${file.name}`;
                preview.appendChild(div);
            }
        });
    });
});
</script>
</body>
</html>
