{% load static %}
{% block content %}
<!-- Bootstrap y Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
  html, body { height:100%; margin:0; font-family:'Poppins', 'Segoe UI', sans-serif; background: url("{% static 'img/exponentes.jpeg' %}") no-repeat center center fixed; background-size: cover; }
  .overlay-login { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:flex-start; padding:2rem; overflow-y:auto; }
  .login-card { width:100%; max-width:1100px; background: rgba(255,255,255,0.08); backdrop-filter: blur(15px); border-radius:20px; padding:2rem; color:white; box-shadow:0 0 30px rgba(0,0,0,0.3); }
  h3,h4,h5 { color:#e1bee7; text-shadow:0 0 10px rgba(156,39,176,0.4); }
  label { color:#f3e5f5; font-weight:500; }
  .form-control { background: rgba(255,255,255,0.1); border:none; color:white; border-radius:12px; padding:0.75rem 1rem; }
  .form-control:focus { background: rgba(255,255,255,0.2); box-shadow:0 0 8px rgba(156,39,176,0.6); }
  .btn-login { background: linear-gradient(135deg, #7b1fa2, #4a148c); border:none; border-radius:25px; padding:0.8rem; font-weight:600; font-size:1rem; color:#fff; transition:0.3s; }
  .btn-login:hover { transform: scale(1.05); background: linear-gradient(135deg, #9c27b0, #6a1b9a); }
  .table-container { background: rgba(255,255,255,0.05); border-radius:15px; padding:1rem; max-height:400px; overflow-y:auto; overflow-x:auto; scrollbar-width: thin; scrollbar-color: #ab47bc rgba(255,255,255,0.1); }
  .table-container::-webkit-scrollbar { height:10px; width:10px; }
  .table-container::-webkit-scrollbar-thumb { background:#ab47bc; border-radius:8px; }
  .table-container::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
  table { width:100%; border-collapse:collapse; color:#e0e0e0; border-radius:15px; overflow:hidden; }
  th, td { padding:10px 14px; text-align:center; white-space:nowrap; }
  th { background: rgba(156,39,176,0.8); color:white; text-transform:uppercase; font-size:0.9rem; position:sticky; top:0; z-index:1; }
  tbody tr { background: rgba(0,0,0,0.3); transition: background 0.3s, transform 0.2s; }
  tbody tr:hover { background: rgba(156,39,176,0.2); transform: scale(1.01); }
  td { border-bottom:1px solid rgba(255,255,255,0.1); font-size:0.9rem; }
  .btn-table { display:inline-flex; align-items:center; gap:5px; font-size:0.8rem; padding:4px 8px; border-radius:8px; }
  hr { border-color: rgba(255,255,255,0.15); }
  .export-buttons { display:flex; justify-content:end; gap:10px; flex-wrap:wrap; }
  .btn-success, .btn-danger { border-radius:10px; font-weight:500; }
  .search-box { margin-bottom:1rem; display:flex; align-items:center; gap:10px; }
  .search-box input { flex:1; border-radius:12px; background: rgba(255,255,255,0.1); border:none; color:white; padding:0.7rem 1rem; }
  .search-box input::placeholder { color:#d1c4e9; }
  .search-box i { color:#ba68c8; font-size:1.3rem; }
</style>

<div class="overlay-login">
  <div class="login-card">
    <h3 class="text-center mb-4">üìù Registro de Participante</h3>

    <form method="post" enctype="multipart/form-data" action="{% url 'registro_participante' %}">
      {% csrf_token %}
      <div class="row">
        <div class="col-md-6 mb-3">
          <label>C√≥digo participante</label>
          <input type="text" name="cod_part" class="form-control" value="{{ nuevo_cod }}" readonly>
        </div>
        <div class="col-md-6 mb-3">
          <label>Nombres</label>
          <input type="text" name="nombres" class="form-control">
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label>DNI</label>
          <input type="text" name="dni" class="form-control">
        </div>
        <div class="col-md-6 mb-3">
          <label>Celular</label>
          <input type="text" name="celular" class="form-control" maxlength="9">
        </div>
      </div>

      <div class="mb-3">
        <label>Asesor</label>
        <input type="text" name="asesor" class="form-control">
      </div>

      <!-- NUEVO: Subir voucher al registrar -->
      <div class="mb-3">
        <label>Voucher (opcional)</label>
        <input type="file" name="voucher_file" accept="image/*,.pdf" class="form-control">
      </div>

      <h5 class="text-center">üìÅ Carga Masiva (Excel)</h5>
      <input type="file" name="excel_file" accept=".xlsx,.xls" class="form-control mb-3">

      <button type="submit" class="btn btn-login w-100">Registrar Participante / Carga Masiva</button>
    </form>

    <hr class="my-4">

    <h4 class="text-center mb-3">üìã Participantes Registrados</h4>

    <form method="post" action="{% url 'enviar_todos_whatsapp' %}" onsubmit="return confirm('¬øDeseas enviar los mensajes de WhatsApp a todos los participantes?');">
      {% csrf_token %}
      <button type="submit" class="btn btn-success">
        <i class="bi bi-whatsapp"></i> Enviar todos los WhatsApp
      </button>
    </form>

    <div class="export-buttons mb-3">
      <a href="{% url 'exportar_excel_previo' %}" class="btn btn-success">
        <i class="bi bi-file-earmark-spreadsheet"></i> Excel
      </a>
      <a href="{% url 'exportar_pdf_previo' %}" class="btn btn-danger">
        <i class="bi bi-file-earmark-pdf"></i> PDF
      </a>
    </div>

    <!-- üîç Buscador -->
    <div class="search-box">
      <i class="bi bi-search"></i>
      <input type="text" id="searchInput" placeholder="Buscar por nombre o DNI...">
    </div>

    <div class="table-container">
      <table id="participantesTable">
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th>DNI</th>
            <th>Celular</th>
            <th>Asesor</th>
            <th>QR</th>
            <th>Vouchers</th>
            <th>Contabilidad</th>
            <th>Administraci√≥n</th>
            <th>WhatsApp</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for p in participantes %}
          <tr>
            <td>{{ p.cod_part }}</td>
            <td>{{ p.nombres }}</td>
            <td>{{ p.dni }}</td>
            <td>{{ p.celular }}</td>
            <td>{{ p.asesor }}</td>
            <td>
              {% if p.qr_image %}
                <a href="{{ p.qr_image.url }}" target="_blank">
                  <img src="{{ p.qr_image.url }}" alt="QR" style="width:50px; height:50px; border-radius:8px;">
                </a>
              {% else %}
                <span class="text-muted">Sin QR</span>
              {% endif %}
            </td>
            <td>
              {% for v in p.vouchers.all %}
                <a href="{{ v.imagen.url }}" target="_blank">üìé Ver</a><br>
              {% empty %}
                <span class="text-muted">Sin vouchers</span>
              {% endfor %}
            </td>
            <td><input type="checkbox" {% if p.validado_contabilidad %}checked{% endif %}></td>
            <td><input type="checkbox" {% if p.validado_administracion %}checked{% endif %}></td>
            <td>
              {% if p.celular and p.qr_image %}
                <a href="{% url 'enviar_whatsapp_qr' p.cod_part %}" class="btn btn-success btn-sm btn-table">
                  <i class="bi bi-whatsapp"></i> QR
                </a>
              {% else %}
                <span class="text-muted">N/A</span>
              {% endif %}
            </td>
            <td>
              <div class="d-flex justify-content-center gap-2">
                <a href="{% url 'actualizar_participante_previa' p.id %}" class="btn btn-warning btn-sm btn-table">
                  <i class="bi bi-pencil-square"></i>
                </a>
                <form method="post" action="{% url 'eliminar_participante_previa' p.id %}" style="display:inline;">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger btn-sm btn-table" onclick="return confirm('¬øEst√°s seguro de eliminar este participante?');">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="11">No hay participantes a√∫n</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
document.getElementById("searchInput").addEventListener("keyup", function() {
  const filter = this.value.toLowerCase();
  const rows = document.querySelectorAll("#participantesTable tbody tr");
  rows.forEach(row => {
    const nombre = row.cells[1]?.textContent.toLowerCase() || "";
    const dni = row.cells[2]?.textContent.toLowerCase() || "";
    row.style.display = (nombre.includes(filter) || dni.includes(filter)) ? "" : "none";
  });
});
</script>
{% endblock %}
