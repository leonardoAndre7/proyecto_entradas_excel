{% load static %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
  html, body { height:100%; margin:0; font-family:'Poppins', 'Segoe UI', sans-serif; background: url("{% static 'img/nexo_logo_01.png' %}") no-repeat center center fixed; background-size: cover; }
  .overlay-login { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:flex-start; padding:2rem; overflow-y:auto; }
  .login-card { width:100%; max-width:1100px; background: rgba(255,255,255,0.08); backdrop-filter: blur(15px); border-radius:20px; padding:2rem; color:white; box-shadow:0 0 30px rgba(0,0,0,0.3); }
  h3,h4,h5 { color:#e1bee7; text-shadow:0 0 10px rgba(156,39,176,0.4); }
  label { color:#f3e5f5; font-weight:500; }
  .form-control { background: rgba(255,255,255,0.1); border:none; color:white; border-radius:12px; padding:0.75rem 1rem; }
  .form-control:focus { background: rgba(255,255,255,0.2); box-shadow:0 0 8px rgba(156,39,176,0.6); }
  .btn-login { background: linear-gradient(135deg, #0000FF, #4a148c); border:none; border-radius:25px; padding:0.8rem; font-weight:600; font-size:1rem; color:#fff; transition:0.3s; }
  .btn-login:hover { transform: scale(1.05); background: linear-gradient(135deg, #0000FF, #6a1b9a); }
  .table-container { background: rgba(255,255,255,0.05); border-radius:15px; padding:1rem; max-height:400px; overflow-y:auto; overflow-x:auto; scrollbar-width: thin; scrollbar-color: #0000FF rgba(255,255,255,0.1); }
  .table-container::-webkit-scrollbar { height:10px; width:10px; }
  .table-container::-webkit-scrollbar-thumb { background:#ab47bc; border-radius:8px; }
  .table-container::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
  table { width:100%; border-collapse:collapse; color:#e0e0e0; border-radius:15px; overflow:hidden; }
  th, td { padding:10px 14px; text-align:center; white-space:nowrap; }
  th { background: #0000FF; color:white; text-transform:uppercase; font-size:0.9rem; position:sticky; top:0; z-index:1; }
  tbody tr { background: rgba(0,0,0,0.3); transition: background 0.3s, transform 0.2s; }
  tbody tr:hover { background: rgba(156,39,176,0.2); transform: scale(1.01); }
  td { border-bottom:1px solid rgba(255,255,255,0.1); font-size:0.9rem; }
  .btn-table { display:inline-flex; align-items:center; gap:5px; font-size:0.8rem; padding:4px 8px; border-radius:8px; }
  hr { border-color: rgba(255,255,255,0.15); }
  .export-buttons { display:flex; justify-content:end; gap:10px; flex-wrap:wrap; }
  .btn-success, .btn-danger { border-radius:10px; font-weight:500; }
  .search-box { margin-bottom:1rem; display:flex; align-items:center; gap:10px; }
  .search-box input { flex:1; border-radius:12px; background: rgba(255,255,255,0.1); border:none; color:white; padding:0.7rem 1rem; }
  .search-box input::placeholder { color:#d1c4e9; }
  .search-box i { color:#ba68c8; font-size:1.3rem; }

  form, 
form label, 
form input, 
form select, 
form textarea {
    color: white !important;
}

form input::placeholder {
    color: #ddd !important;
}

/* PAGINACI칍N PROFESIONAL */
.pagination {
  gap: 8px;
}

.page-item .page-link {
  background: rgba(255, 255, 255, 0.08);
  border: none;
  color: #e1bee7;
  border-radius: 12px;
  padding: 8px 14px;
  font-weight: 500;
  backdrop-filter: blur(8px);
  transition: all 0.25s ease;
}

.page-item .page-link:hover {
  background: linear-gradient(135deg, #0000FF, #6a1b9a);
  color: #fff;
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(156, 39, 176, 0.4);
}

.page-item.active .page-link {
  background: linear-gradient(135deg, #0000FF, #4a148c); 
  color: #fff;
  font-weight: 600;
  box-shadow: 0 0 15px rgba(156, 39, 176, 0.6);
}

.page-item.disabled .page-link {
  background: rgba(255, 255, 255, 0.04);
  color: rgba(255, 255, 255, 0.3);
  cursor: not-allowed;
}


</style>

<div class="overlay-login">
  <div class="login-card">
    <h3 class="text-center mb-4">游닇 Registro de Participante</h3>

    <form method="post" enctype="multipart/form-data" action="{% url 'registro_participante' %}">
      {% csrf_token %}
      <div class="row">
        <div class="col-md-6 mb-3">
          <label>C칩digo participante</label>
          <input type="text" name="cod_part" class="form-control" value="{{ nuevo_cod }}" readonly>
        </div>
        <div class="col-md-6 mb-3">
          <label>Nombres</label>
          <input type="text" name="nombres" class="form-control">
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 mb-3">
          <label>DNI</label>
          <input type="text" name="dni" class="form-control">
        </div>
        <div class="col-md-4 mb-3">
          <label>Celular</label>
          <input type="text" name="celular" class="form-control" maxlength="9">
        </div>
        <div class="col-md-4 mb-3">
          <label>Correo</label>
          <input type="email" name="correo" class="form-control" placeholder="correo@ejemplo.com">
        </div>
      </div>

      <h5 class="text-center">游늬 Carga Masiva (Excel)</h5>
      <input type="file" name="excel_file" accept=".xlsx,.xls" class="form-control mb-3">

      <button type="submit" class="btn btn-login w-100">Registrar Participante / Carga Masiva</button>
    </form>

    <hr class="my-4">

    <h4 class="text-center mb-3">游늶 Participantes Registrados</h4>

    <form method="post" action="{% url 'enviar_todos_whatsapp' %}" onsubmit="return confirm('쮻eseas enviar los mensajes de WhatsApp a todos los participantes?');">
      {% csrf_token %}
      <button type="submit" class="btn btn-success d-flex align-items-center gap-2" style="background: linear-gradient(90deg, #25D366, #128C7E); border: none;">
        <i class="bi bi-whatsapp"></i>
        <i class="bi bi-envelope-fill"></i>
        <span>Enviar a todos (WSP Y Correo)</span>
      </button>
    </form>

    <div class="export-buttons mb-3">
      <a href="{% url 'exportar_excel_previo' %}" class="btn btn-success">
        <i class="bi bi-file-earmark-spreadsheet"></i> Excel
      </a>
      <a href="{% url 'exportar_pdf_previo' %}" class="btn btn-danger">
        <i class="bi bi-file-earmark-pdf"></i> PDF
      </a>
    </div>

    <!-- Buscador -->
    <form method="get" class="row g-2 mb-3">
  <div class="col-md-10">
    <input
      type="text"
      name="q"
      value="{{ request.GET.q }}"
      class="form-control"
      placeholder="Buscar por nombre, DNI, celular, correo o c칩digo"
    >
  </div>

  <div class="col-md-2 d-grid">
    <button class="btn btn-primary" type="submit">
      游댌 Buscar
    </button>
  </div>
</form>

    <div class="table-container">
      <table id="participantesTable">
        <thead>
          <tr>
            <th>#</th>
            {% comment %} <th>C칩digo</th> {% endcomment %}
            <th>Nombre</th>
            <th>DNI</th>
            {% comment %} <th>Celular</th> {% endcomment %}
            <th>Correo</th>
            {% comment %} <th>QR</th> {% endcomment %}
            <th>WhatsApp / Correo</th>
            <th>Ingreso</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for p in participantes %}
          <tr>
            <td>
              {{ p.id }}
            </td>

            {% comment %} <td>{{ p.cod_part }}</td> {% endcomment %}
            <td>{{ p.nombres }}</td>
            <td>{{ p.dni }}</td>
            {% comment %} <td>{{ p.celular }}</td> {% endcomment %}
            <td>{{ p.correo }}</td>
            {% comment %} <td>
                <a href="{% url 'qr_preview' p.token %}">Ver QR</a>
            </td> {% endcomment %}
            {% comment %} <td>
                <a href="{% url 'qr_preview' p.token %}">Ver QR</a>
            </td> {% endcomment %}

            <td>
            {% if p.enviado %}
              <button class="btn btn-secondary btn-sm btn-table" disabled>
                <i class="bi bi-check2-circle"></i> Enviado
              </button>
            {% else %}
              <form method="post" action="{% url 'enviar_whatsapp_qr' p.cod_part %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-success btn-sm btn-table d-flex align-items-center gap-1"
                        style="background: linear-gradient(90deg, #25D366, #128C7E); border: none;">
                  <i class="bi bi-whatsapp"></i>
                  <i class="bi bi-envelope-fill"></i>
                  <span>Enviar QR</span>
                </button>
              </form>

            {% endif %}
            </td>



            <td>
                {% if p.entrada_usada %}
                    <span class="badge bg-success">
                        <i class="bi bi-check-circle-fill"></i> Entr칩
                    </span>
                {% else %}
                    <a href="{% url 'marcar_ingreso' p.pk %}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-door-open"></i> Marcar
                    </a>
                {% endif %}
            </td>

            <td>
              <div class="d-flex justify-content-center gap-2">
                <a href="{% url 'actualizar_participante_previa' p.id %}" class="btn btn-warning btn-sm btn-table">
                  <i class="bi bi-pencil-square"></i>
                </a>
                <form method="post" action="{% url 'eliminar_participante_previa' p.id %}" style="display:inline;">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger btn-sm btn-table" onclick="return confirm('쮼st치s seguro de eliminar este participante?');">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="11">No hay participantes a칰n</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

 <nav class="mt-4">
  <ul class="pagination justify-content-center">

    {% if participantes.has_previous %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ participantes.previous_page_number }}">
          Anterior
        </a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">Anterior</span>
      </li>
    {% endif %}

    <li class="page-item disabled">
      <span class="page-link">
        P치gina {{ participantes.number }} de {{ participantes.paginator.num_pages }}
      </span>
    </li>

    {% if participantes.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="?q={{ request.GET.q }}&page={{ participantes.next_page_number }}">
          Siguiente
        </a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">Siguiente</span>
      </li>
    {% endif %}

  </ul>
</nav>



  </div>
</div>

<script>
document.getElementById("searchInput").addEventListener("keyup", function() {
  const filter = this.value.toLowerCase();
  const rows = document.querySelectorAll("#participantesTable tbody tr");
  rows.forEach(row => {
    const nombre = row.cells[1]?.textContent.toLowerCase() || "";
    const dni = row.cells[2]?.textContent.toLowerCase() || "";
    row.style.display = (nombre.includes(filter) || dni.includes(filter)) ? "" : "none";
  });
});
</script>
{% endblock %}
